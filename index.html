<script>
let level = 1;
let combo = 0;
let maxCombo = 0;
let time = 60;
let currentAnswer = '';
let timer;
let player = '';
let state = 'idle'; // idle | showing | judging

const arrows = ['left','up','right'];
const arrowIcons = { left:'←', up:'↑', right:'→' };

const showTimes = [1500,1300,1100,900,750,600,450];
const coolTimes = [600,550,500,450,400,350,300];

function startGame() {
  player = document.getElementById('playerName').value || 'ゲスト';
  document.getElementById('nameDisplay').textContent = player;
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');

  nextQuestion();
  timer = setInterval(countDown, 1000);
}

function countDown() {
  time--;
  document.getElementById('time').textContent = time;
  if (time <= 0) endGame();
}

function nextQuestion() {
  state = 'showing';
  document.getElementById('feedback').textContent = '';

  currentAnswer = arrows[Math.floor(Math.random() * 3)];
  const arrowEl = document.getElementById('arrow');
  arrowEl.textContent = arrowIcons[currentAnswer];

  setTimeout(() => {
    if (state === 'showing') {
      judge(false); // 時間切れミス
    }
  }, showTimes[level - 1]);
}

function answer(choice) {
  if (state !== 'showing') return;
  judge(choice === currentAnswer);
}

function judge(correct) {
  state = 'judging';
  const fb = document.getElementById('feedback');
  document.getElementById('arrow').textContent = '';

  if (correct) {
    fb.textContent = '✅';
    fb.className = 'correct';
    combo++;
    if (combo > maxCombo) maxCombo = combo;

    if (combo >= 5 && level < 7) {
      level++;
      combo = 0;
    }
  } else {
    fb.textContent = '❌';
    fb.className = 'wrong';
    combo = 0;
  }

  updateDisplay();

  setTimeout(() => {
    state = 'idle';
    nextQuestion();
  }, coolTimes[level - 1]);
}

function updateDisplay() {
  document.getElementById('level').textContent = level;
  document.getElementById('combo').textContent = combo;
  document.getElementById('score').textContent = `${level}.${maxCombo}`;
}

function endGame() {
  clearInterval(timer);
  document.getElementById('game').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');

  const final = `${level}.${maxCombo}`;
  document.getElementById('finalScore').textContent = `スコア：${final}`;
}
</script>
