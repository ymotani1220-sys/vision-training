<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>横回転判断トレーニング</title>

<style>
body{
  margin:0;
  background:#1b5e20;
  display:flex;
  justify-content:center;
  font-family:sans-serif;
}

#game{
  width:360px;
  height:640px;
  background:#2e7d32;
  color:#fff;
  position:relative;
  overflow:hidden;
}

/* ===== 上部 ===== */
#top{
  display:flex;
  justify-content:space-between;
  padding:8px 12px;
  font-size:16px;
}

/* ===== 卓球台 ===== */
#table-wrap{
  position:relative;
  height:520px;
}

#table{
  position:absolute;
  left:50%;
  top:90px;
  transform:translateX(-50%);
  width:220px;
  height:440px;
  background:#1565c0;
  border:4px solid #fff;
  box-sizing:border-box;
}

#line-center{
  position:absolute;
  left:50%;
  top:0;
  width:2px;
  height:100%;
  background:#fff;
  transform:translateX(-50%);
}

#net{
  position:absolute;
  top:50%;
  left:0;
  width:100%;
  height:4px;
  background:#fff;
}

/* ===== ボール ===== */
#ball{
  position:absolute;
  width:24px;
  height:24px;
  border-radius:50%;
  background:#fff;
  display:none;
  z-index:5;
}

/* ===== 回転予測矢印 ===== */
.spin-arrow{
  position:absolute;
  width:64px;
  height:64px;
  border:6px solid #ffeb3b;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  font-weight:bold;
  color:#ffeb3b;
  z-index:6;
}

/* ===== ボタン ===== */
#buttons{
  position:absolute;
  bottom:12px;
  width:100%;
  display:flex;
  justify-content:space-around;
}

.col{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.btn{
  width:64px;
  height:34px;
  background:#eee;
  border-radius:50%;
  position:relative;
}

.btn::after{
  content:"";
  position:absolute;
  width:42px;
  height:3px;
  background:#000;
  top:50%;
  left:50%;
  transform-origin:center;
}

.left::after{ transform:translate(-50%,-50%) rotate(-30deg); }
.straight::after{ transform:translate(-50%,-50%) rotate(0deg); }
.right::after{ transform:translate(-50%,-50%) rotate(30deg); }

/* 正誤 */
.judge{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:28px;
  font-weight:bold;
}
.correct{ color:#00e676; }
.wrong{ color:#ff5252; }
</style>
</head>

<body>
<div id="game">

  <div id="top">
    <div>TIME</div>
    <div id="score">SCORE 0</div>
  </div>

  <div id="table-wrap">
    <div id="table">
      <div id="line-center"></div>
      <div id="net"></div>
    </div>
    <div id="ball"></div>
  </div>

  <div id="buttons"></div>
</div>

<script>
/* ===== 基本設定 ===== */
const table = document.getElementById("table");
const ball = document.getElementById("ball");
const buttons = document.getElementById("buttons");
const scoreEl = document.getElementById("score");

const BALL = 24;
let score = 0;

let correctSpin = 1;     // 0:右曲がり 1:直進 2:左曲がり
let arrivalCourse = 1;  // 0:フォア 1:ミドル 2:バック

/*
spin（プレイヤー目線）
0 = 反時計回り → 右に曲がる
1 = 直進
2 = 時計回り → 左に曲がる
*/
const spinMap = { left:2, straight:1, right:0 };

/* ===== ボタン生成 ===== */
["fore","middle","back"].forEach((_,col)=>{
  const c=document.createElement("div");
  c.className="col";
  ["left","straight","right"].forEach(a=>{
    const b=document.createElement("div");
    b.className="btn "+a;
    b.dataset.col=col;
    b.dataset.angle=a;
    b.onclick=()=>judge(b);
    c.appendChild(b);
  });
  buttons.appendChild(c);
});

/* ===== 出球位置 ===== */
function getServeX(course){
  const r = table.getBoundingClientRect();
  if(course === 0) return r.left;
  if(course === 1) return r.left + r.width/2 - BALL/4;
  return r.left + r.width - BALL*2;
}

/* ===== 到達点（固定） ===== */
function getArrivalX(course){
  const r = table.getBoundingClientRect();
  if(course === 0) return r.left;
  if(course === 1) return r.left + r.width/2 - BALL/2;
  return r.left + r.width - BALL;
}

/* ===== 到達コース決定 ===== */
function calcArrival(start, spin){
  if(spin === 0) return Math.min(2, start+1);
  if(spin === 2) return Math.max(0, start-1);
  return start;
}

/* ===== 曲がり ===== */
const curvePower = 40;

function curveOffset(p, spin){
  if(spin === 1) return 0;
  const dir = (spin === 0) ? 1 : -1;
  return Math.sin(p * Math.PI) * curvePower * dir;
}

/* ===== 回転矢印 ===== */
function showArrow(x,y,spin){
  if(spin === 1) return;

  const a=document.createElement("div");
  a.className="spin-arrow";
  a.textContent = spin === 0 ? "⟲" : "⟳";
  a.style.left = x - 32 + "px";
  a.style.top  = y - 70 + "px";
  document.body.appendChild(a);
  setTimeout(()=>a.remove(),1000);
}

/* ===== 出球 ===== */
function serve(){
  document.querySelectorAll(".judge").forEach(j=>j.remove());

  const startCourse = Math.floor(Math.random()*3);
  correctSpin = Math.floor(Math.random()*3);
  arrivalCourse = calcArrival(startCourse, correctSpin);

  const startX = getServeX(startCourse);
  const endX   = getArrivalX(arrivalCourse);

  const startY = table.offsetTop + 10;
  const travelY = table.offsetHeight - 40;

  let p = 0;
  ball.style.display="block";
  showArrow(startX, startY, correctSpin);

  const timer = setInterval(()=>{
    p += 0.01;

    const x = startX + (endX - startX) * p + curveOffset(p, correctSpin);
    const y = startY + travelY * p;

    ball.style.left = x + "px";
    ball.style.top  = y + "px";

    if(p >= 1){
      clearInterval(timer);
      ball.style.display="none";
      setTimeout(serve, 800);
    }
  },16);
}

/* ===== 判定 ===== */
function judge(btn){
  if(Number(btn.dataset.col) !== arrivalCourse) return;

  const spin = spinMap[btn.dataset.angle];
  const j=document.createElement("div");
  j.className="judge";

  if(spin === correctSpin){
    j.textContent="○";
    j.classList.add("correct");
    score += 10;
    scoreEl.textContent="SCORE " + score;
  }else{
    j.textContent="×";
    j.classList.add("wrong");
  }
  btn.appendChild(j);
}

serve();
</script>
</body>
</html>
