<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å“çƒ ç¬é–“åˆ¤æ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #111;
  color: #fff;
  margin: 0;
  overflow: hidden;
}
.arrow { font-size: 100px; margin: 30px 0; }
#feedback { font-size: 40px; height: 50px; }
button { font-size:22px; padding:15px 25px; margin:10px; }
.hidden { display:none; }
#ranking { text-align:left; max-width:320px; margin:auto; }

/* ğŸ”¥ è¦šé†’æ¼”å‡º */
#awakening {
  position: fixed;
  inset: 0;
  background: rgba(255,0,0,0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 64px;
  font-weight: bold;
  z-index: 999;
  pointer-events: none;
  animation: flash 0.8s ease-out forwards;
}

@keyframes flash {
  0% { opacity: 0; transform: scale(0.8); }
  20% { opacity: 1; transform: scale(1.1); }
  100% { opacity: 0; transform: scale(1.4); }
}
</style>
</head>

<body>

<div id="awakening" class="hidden">ğŸ”¥ è¦šé†’ï¼</div>

<div id="start">
  <h1>ğŸ“ ç¬é–“åˆ¤æ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
  <input id="playerName" placeholder="åå‰">
  <br><br>
  <button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="game" class="hidden">
  ğŸ‘¤ <span id="name"></span><br>
  â± <span id="time">60</span> ç§’ã€€
  ğŸ¯ Lv <span id="level">1</span>ã€€
  ğŸ”¥ <span id="combo">0</span><br>
  â­ <span id="score">1.0</span>

  <div id="arrow" class="arrow"></div>
  <div id="feedback"></div>

  <button onclick="answer('left')">â†</button>
  <button onclick="answer('up')">â†‘</button>
  <button onclick="answer('right')">â†’</button>
</div>

<div id="result" class="hidden">
  <h2>ğŸ‰ çµæœ</h2>
  <p id="finalScore"></p>
  <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
  <ol id="ranking"></ol>
  <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
</div>

<script>
/* ===== å¤‰æ•° ===== */
let level = 1;
let combo = 0;
let maxCombo = 0;
let time = 60;
let timer = null;
let questionTimer = null;
let player = '';
let answered = false;
let current = '';
let level7TotalCombo = 0;

/* ğŸ”¥ è¦šé†’ç®¡ç† */
let awakened = false;

/* ğŸ”Š BGM */
const level7BGM = new Audio("bgm/level7.mp3");
level7BGM.loop = true;
level7BGM.volume = 0.6;
let audioUnlocked = false;
let level7BgmPlaying = false;

const arrows = ['left','up','right'];
const icons = {left:'â†', up:'â†‘', right:'â†’'};
const showTimes = [1500,1300,1100,900,750,600,450];

/* ===== é–‹å§‹ ===== */
function startGame(){
  // ğŸ”„ ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
  level = 1;
  combo = 0;
  maxCombo = 0;
  time = 60;
  level7TotalCombo = 0;
  awakened = false;
  level7BgmPlaying = false;

  // ğŸ”¥ è¦šé†’ç”»é¢ã‚’ç¢ºå®Ÿã«æ¶ˆã™
  document.getElementById('awakening').classList.add('hidden');

  player = document.getElementById('playerName').value || 'ã‚²ã‚¹ãƒˆ';
  document.getElementById('name').textContent = player;

  document.getElementById('start').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');

  if(!audioUnlocked){
    level7BGM.play().then(()=>{
      level7BGM.pause();
      level7BGM.currentTime = 0;
      audioUnlocked = true;
    });
  }

  document.getElementById('time').textContent = time;

  timer = setInterval(()=>{
    time--;
    document.getElementById('time').textContent = time;
    if(time<=0) endGame();
  },1000);

  nextQuestion();
}

/* ===== æ¬¡ã®å•é¡Œ ===== */
function nextQuestion(){
  clearTimeout(questionTimer);
  answered = false;
  document.getElementById('feedback').textContent = '';

  current = arrows[Math.floor(Math.random()*3)];
  document.getElementById('arrow').textContent = icons[current];

  questionTimer = setTimeout(()=>{
    if(!answered) judge(false);
  }, showTimes[level-1]);
}

/* ===== å›ç­” ===== */
function answer(choice){
  if(answered) return;
  judge(choice === current);
}

/* ===== åˆ¤å®š ===== */
function judge(correct){
  answered = true;
  clearTimeout(questionTimer);
  document.getElementById('arrow').textContent = '';

  if(correct){
    combo++;
    maxCombo = Math.max(maxCombo, combo);

    if(level < 7 && combo >= 5){
      level++;
      combo = 0;

      if(level === 7 && !awakened){
        awakened = true;
        const a = document.getElementById('awakening');
        a.classList.remove('hidden');
        setTimeout(()=>a.classList.add('hidden'), 800);
      }
    }

    if(level === 7){
      level7TotalCombo++;
    }

  } else {
    combo = 0;
  }

  updateUI();
  setTimeout(nextQuestion, 400);
}

/* ===== è¡¨ç¤ºæ›´æ–° ===== */
function updateUI(){
  document.getElementById('level').textContent = level;
  document.getElementById('combo').textContent = combo;

  let scoreBase = level;
  let scoreDecimal = maxCombo;

  if(level === 7){
    scoreBase = 7 + Math.floor(level7TotalCombo / 5);
    scoreDecimal = level7TotalCombo % 5 + 1;
  }

  document.getElementById('score').textContent =
    `${scoreBase}.${scoreDecimal}`;

  if(level === 7 && audioUnlocked && !level7BgmPlaying){
    level7BGM.currentTime = 0;
    level7BGM.play();
    level7BgmPlaying = true;
  }
}

/* ===== çµ‚äº† ===== */
function endGame(){
  clearInterval(timer);
  clearTimeout(questionTimer);

  level7BGM.pause();
  level7BGM.currentTime = 0;

  document.getElementById('awakening').classList.add('hidden');

  saveScore();
  showRanking();

  document.getElementById('game').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');
  document.getElementById('finalScore').textContent =
    `ã‚¹ã‚³ã‚¢ï¼š${document.getElementById('score').textContent}`;
}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== */
function saveScore(){
  const score = Number(document.getElementById('score').textContent);
  const r = {name:player, score};
  const list = JSON.parse(localStorage.getItem('ranking')||'[]');
  list.push(r);
  list.sort((a,b)=>b.score-a.score);
  localStorage.setItem('ranking', JSON.stringify(list.slice(0,100)));
}

function showRanking(){
  const list = JSON.parse(localStorage.getItem('ranking')||'[]');
  const ol = document.getElementById('ranking');
  ol.innerHTML = '';
  list.forEach((r,i)=>{
    const li = document.createElement('li');
    li.textContent = `${i+1}. ${r.name}ï¼ˆ${r.score}ï¼‰`;
    ol.appendChild(li);
  });
}
</script>

</body>
</html>
