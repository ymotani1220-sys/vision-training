<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>打点判断トレーニング</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  overflow:hidden;
}

#game{
  position:relative;
  width:100%;
  max-width:420px;
  height:100vh;
}

#info{
  position:absolute;
  top:10px;
  width:100%;
  text-align:center;
  font-size:22px;
  z-index:10;
}

#judge{
  font-size:42px;
  height:48px;
  margin-bottom:4px;
}

#ball{
  position:absolute;
  width:48px;
  height:48px;
  border-radius:50%;
  background:white;
  box-shadow:0 0 12px rgba(255,255,255,0.8);
}

#floor{
  position:absolute;
  bottom:80px;
  width:100%;
  height:4px;
  background:#888;
}
</style>
</head>

<body>

<div id="game">
  <div id="info">
    <div id="judge"></div>
    Lv <span id="lv">1</span>　
    ⭐ <span id="score">1.0</span>
  </div>

  <div id="ball"></div>
  <div id="floor"></div>
</div>

<script>
/* ===== レベル別背景 ===== */
const bgColors=['#111','#1a2635','#1a3526','#352a1a','#351a1a','#261a35','#351a35'];
function updateBg(lv){
  document.body.style.background = bgColors[Math.min(lv-1, bgColors.length-1)];
}

/* ===== DOM ===== */
const ball = document.getElementById('ball');
const floor = document.getElementById('floor');
const judgeEl = document.getElementById('judge');
const lvEl = document.getElementById('lv');
const scoreEl = document.getElementById('score');

/* ===== ゲーム状態 ===== */
let level=1, combo=0;
let x=0,y=0,vx=0,vy=0;
let gravity=0.5;
let running=false;
let bounced=0;
let touched=false;

/* ===== 定数 ===== */
const ballR=24;
const restitution=0.85;

/* ===== トップスピン強度（伸び） ===== */
function spinStrength(lv){
  if(lv < 5) return 0;
  return 0.06 * (lv - 4); // Lv5〜強くなる
}

/* ===== 初期化 ===== */
function serve(){
  const w = window.innerWidth;
  const h = window.innerHeight;
  const floorY = floor.offsetTop;

  bounced=0;
  touched=false;
  judgeEl.textContent='';

  // 打ち出し位置（Lvが上がると低く）
  y = floorY - 120 + Math.max(0, (level-4)*20);
  x = 40;

  // 横スピード
  vx = 3 + level * 0.8;

  // 打ち出し角（Lvが上がると下向き）
  vy = -6 + level * 0.6;

  // 重力
  gravity = level < 3 ? 0.25 : 0.6;

  running=true;
}

/* ===== 判定 ===== */
ball.addEventListener('pointerdown',()=>{
  if(bounced===1 && !touched){
    touched=true;
    running=false;
    judgeEl.textContent='〇';
    judgeEl.style.color='#0f9';
    combo++;
    if(combo>=5){ level++; combo=0; updateBg(level); }
    updateScore();
    setTimeout(serve,600);
  }
});

/* ===== スコア ===== */
function updateScore(){
  lvEl.textContent=level;
  scoreEl.textContent=`${level}.${combo}`;
}

/* ===== メインループ ===== */
function loop(){
  if(running){
    vy += gravity;
    x += vx;
    y += vy;

    const floorY = floor.offsetTop;

    // バウンド判定（表面接地）
    if(y + ballR >= floorY && vy > 0){
      y = floorY - ballR;
      vy = -vy * restitution;
      bounced++;

      // ===== 伸び（トップスピン摩擦）=====
      const spin = spinStrength(level);
      vx += vx * spin;

      if(bounced>=2){
        running=false;
        judgeEl.textContent='✖';
        judgeEl.style.color='#f33';
        combo=0;
        updateScore();
        setTimeout(serve,600);
      }
    }

    // 画面外
    if(x > window.innerWidth+50) running=false;

    ball.style.transform = `translate(${x-ballR}px, ${y-ballR}px)`;
  }
  requestAnimationFrame(loop);
}

/* ===== 開始 ===== */
updateBg(1);
updateScore();
serve();
loop();
</script>

</body>
</html>
