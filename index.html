<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>横回転判断トレーニング - 60秒集中ver</title>

<style>
body{
  margin:0;
  background:#111;
  font-family:sans-serif;
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  height:100vh;
  overflow: hidden;
  touch-action: manipulation;
}

/* ===== 共通パネル ===== */
.info-panel {
  width: 100%;
  max-width: 400px;
  padding: 15px 10px;
  display: flex;
  justify-content: space-around;
  font-size: 22px;
  text-align: center;
}
.score-highlight { font-size: 32px; color: #ffeb3b; font-weight: bold; }

/* ===== コートエリア ===== */
.court-wrapper{
  position:relative;
  width:100%;
  max-width:380px;
  height:400px;
  margin: 10px 0;
}

.court{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:280px;
  height:100%;
  background:#1c6b3c;
  border: 3px solid #fff;
  box-sizing: border-box;
}

.line{ position:absolute; background:#fff; }
.centerline{ left:50%; top:0; width:2px; height:100%; transform:translateX(-50%); opacity: 0.6; }
.net{
  position:absolute; top:50%; left:0; width:100%; height:4px;
  background:rgba(255,255,255,0.8); z-index:2; box-shadow: 0 0 10px rgba(255,255,255,0.5);
}

/* ===== ボールと回転演出 ===== */
.ball{
  position:absolute;
  width:24px;
  height:24px;
  background:#ffcc00;
  border-radius:50%;
  transform:translate(-50%,-50%);
  z-index:10;
  box-shadow: 0 0 15px rgba(255,204,0,0.8);
}

.spin-arrow{
  position:absolute;
  width:80px;
  height:80px;
  border:6px solid #ff5555;
  border-radius:50%;
  display:none;
  z-index: 5;
  opacity: 0.5;
}
.spin-arrow.ccw{ border-right-color:transparent; animation: spin-ccw 0.5s linear infinite; }
.spin-arrow.cw{ border-left-color:transparent; animation: spin-cw 0.5s linear infinite; }

@keyframes spin-ccw { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(-360deg); } }
@keyframes spin-cw { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }

/* ===== 判断ボタンエリア ===== */
.buttons-container {
  display: flex;
  gap: 12px;
  margin-top: 5px;
}

.btn-col{
  display:flex;
  flex-direction:column;
  gap:8px;
  background: rgba(255,255,255,0.05);
  padding: 8px;
  border-radius: 12px;
}

.btn{
  width:85px;
  height:45px;
  background:#444;
  border-radius:22px;
  border:2px solid #fff;
  position:relative;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: transform 0.1s;
}
.btn:active { transform: scale(0.95); }

.btn.correct{background:#0f9 !important; box-shadow: 0 0 15px #0f9;}
.btn.wrong{background:#f33 !important; box-shadow: 0 0 15px #f33;}

.angle-line{
  width:32px;
  height:5px;
  background:#fff;
  border-radius: 3px;
}
.angle-left{ transform: rotate(-25deg); }
.angle-center{ transform: rotate(0deg); }
.angle-right{ transform: rotate(25deg); }

#feedback { font-size: 45px; height: 50px; font-weight: bold; margin-bottom: 5px; }
</style>
</head>

<body>

<div class="info-panel">
  <div>⏱ <span id="timeDisp">60</span></div>
  <div>スコア：<span id="scoreDisp" class="score-highlight">1.0</span></div>
</div>

<div id="feedback"></div>

<div class="court-wrapper" id="wrapper">
  <div class="spin-arrow" id="spinArrow"></div>
  <div class="court">
    <div class="line centerline"></div>
    <div class="net"></div>
  </div>
  <div class="ball" id="ball"></div>
</div>

<div class="buttons-container" id="buttons"></div>

<script>
/* --- ゲーム設定 --- */
let currentLvl = 1;
let currentCombo = 0;
let timeLeft = 60;
let correctCol = 0;
let correctSpin = 1;
let isAnswered = false;
let gameActive = true;

// レベルごとの球の表示時間（ms）
// Lv1: 2.5s, Lv2: 2.2s, Lv3: 1.9s, Lv4: 1.6s, Lv5: 1.3s, Lv6: 1.1s, Lv7: 0.9s, Lv8+: 0.8s
const speedSettings = [2500, 2200, 1900, 1600, 1300, 1100, 900, 800];
const curvePower = 85;

const ball = document.getElementById("ball");
const spinArrow = document.getElementById("spinArrow");
const wrapper = document.getElementById("wrapper");

/* ===== ボタン生成 ===== */
for(let col=0; col<3; col++){
  const colDiv=document.createElement("div");
  colDiv.className="btn-col";
  
  ["left","center","right"].forEach(type=>{
    const btn=document.createElement("div");
    btn.className="btn";
    btn.dataset.col=col;
    btn.dataset.type=type;

    const line=document.createElement("div");
    line.className="angle-line angle-"+type;
    btn.appendChild(line);

    btn.onclick=()=>judge(btn);
    colDiv.appendChild(btn);
  });
  document.getElementById("buttons").appendChild(colDiv);
}

/* タイマー処理 */
const timerId = setInterval(() => {
  if(!gameActive) return;
  timeLeft--;
  document.getElementById("timeDisp").textContent = timeLeft;
  if(timeLeft <= 0) {
    gameActive = false;
    clearInterval(timerId);
    alert("修行終了！ 最終スコア: " + currentLvl + "." + currentCombo);
    location.reload();
  }
}, 1000);

function curveOffset(p, spin){
  if(spin === 1) return 0;
  const dir = (spin === 0) ? -1 : 1;
  // サインカーブで曲がりを表現
  return Math.sin(p * Math.PI) * curvePower * dir;
}

function launchBall(){
  if(!gameActive) return;
  isAnswered = false;
  document.getElementById("feedback").textContent = "";
  
  const w = wrapper.clientWidth;
  const startCols = [60, w/2, w - 60];

  const startCol = Math.floor(Math.random()*3);
  const spin = Math.floor(Math.random()*3); // 0:左回転(右へ曲がる), 1:無回転, 2:右回転(左へ曲がる)

  correctCol = startCol;
  correctSpin = spin;

  const startX = startCols[startCol];
  const startY = 30;
  const endY = 370;

  spinArrow.style.display = spin === 1 ? "none" : "block";
  spinArrow.className = "spin-arrow " + (spin === 0 ? "ccw" : "cw");
  spinArrow.style.left = startX + "px";
  spinArrow.style.top = startY + "px";

  const startTime = performance.now();
  // 現在のレベルに応じた速度を取得
  const duration = speedSettings[Math.min(currentLvl-1, speedSettings.length-1)];

  function animate(t){
    if(!gameActive) return;
    const p = Math.min((t - startTime) / duration, 1);
    const x = startX + curveOffset(p, spin);
    const y = startY + (endY - startY) * p;

    ball.style.left = x + "px";
    ball.style.top = y + "px";

    if(p < 1 && !isAnswered) {
      requestAnimationFrame(animate);
    } else if (p >= 1 && !isAnswered) {
      judge(null); // 時間切れミス
    }
  }
  requestAnimationFrame(animate);
}

function judge(btn){
  if(isAnswered || !gameActive) return;
  isAnswered = true;
  
  const fb = document.getElementById("feedback");
  // spin 0(CCW)=ball曲がるのは右, btn選択は'right' / spin 2(CW)=ball曲がるのは左, btn選択は'left'
  const spinType = correctSpin === 0 ? "right" : correctSpin === 1 ? "center" : "left";

  if(btn && Number(btn.dataset.col) === correctCol && btn.dataset.type === spinType){
    btn.classList.add("correct");
    fb.textContent = "〇"; fb.style.color = "#0f9";
    currentCombo++;
    if(currentCombo >= 5) { currentLvl++; currentCombo = 0; }
  } else {
    if(btn) btn.classList.add("wrong");
    fb.textContent = "✖"; fb.style.color = "#f33";
    currentCombo = 0;
  }

  document.getElementById("scoreDisp").textContent = currentLvl + "." + currentCombo;
  
  setTimeout(()=>{
    document.querySelectorAll(".btn").forEach(b=>b.classList.remove("correct","wrong"));
    if(gameActive) launchBall();
  }, 600);
}

launchBall();
</script>
</body>
</html>
