<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>打点判断トレーニング</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  overflow:hidden;
}
#game{
  position:relative;
  width:100%;
  max-width:420px;
  height:100vh;
}
#info{
  position:absolute;
  top:10px;
  width:100%;
  text-align:center;
  font-size:22px;
  z-index:10;
}
#judge{
  font-size:42px;
  height:48px;
}
#ball{
  position:absolute;
  width:48px;
  height:48px;
  border-radius:50%;
  background:#fff;
  box-shadow:0 0 12px rgba(255,255,255,0.8);
}
#floor{
  position:absolute;
  bottom:80px;
  width:100%;
  height:4px;
  background:#888;
}
</style>
</head>

<body>

<div id="game">
  <div id="info">
    <div id="judge"></div>
    Lv <span id="lv">1</span>　
    ⭐ <span id="score">1.0</span>
  </div>
  <div id="ball"></div>
  <div id="floor"></div>
</div>

<script>
/* ===== 背景 ===== */
const bgColors=['#111','#1a2635','#1a3526','#352a1a','#351a1a','#261a35','#351a35'];
function updateBg(lv){
  document.body.style.background =
    bgColors[Math.min(lv-1,bgColors.length-1)];
}

/* ===== DOM ===== */
const ball=document.getElementById('ball');
const floor=document.getElementById('floor');
const judgeEl=document.getElementById('judge');
const lvEl=document.getElementById('lv');
const scoreEl=document.getElementById('score');

/* ===== 状態 ===== */
let level=1, combo=0;
let x=0,y=0,vx=0,vy=0;
let gravity=0.5;
let running=false;
let bounced=0;
let touched=false;

const ballR=24;
const restitution=0.85;

/* ===== 伸び ===== */
function spinStrength(lv){
  if(lv<5) return 0;
  return 0.07*(lv-4);
}

/* ===== 打ち出し ===== */
function serve(){
  const floorY=floor.offsetTop;

  bounced=0;
  touched=false;
  judgeEl.textContent='';

  /* 打ち出し高さ調整 */
  let baseHeight=140;
  if(level>=5){
    baseHeight += (level-4)*15; // ←今回の修正
  } else {
    baseHeight -= level*10;
  }

  y=floorY-baseHeight;
  x=40;

  /* 横スピード（Lv7,8強化） */
  vx=3+level*0.9;
  if(level>=7){
    vx+= (level-6)*1.6;
  }

  /* 縦初速（下向き過多を防ぐ） */
  vy=-5+level*0.4;

  gravity = level<3 ? 0.25 : 0.6;

  running=true;
}

/* ===== タッチ ===== */
ball.addEventListener('pointerdown',()=>{
  if(bounced===1 && !touched){
    touched=true;
    running=false;
    judgeEl.textContent='〇';
    judgeEl.style.color='#0f9';

    combo++;
    if(combo>=5){
      level++;
      combo=0;
      updateBg(level);
    }
    updateScore();
    setTimeout(serve,600);
  }
});

/* ===== スコア ===== */
function updateScore(){
  lvEl.textContent=level;
  scoreEl.textContent=`${level}.${combo}`;
}

/* ===== ループ ===== */
function loop(){
  if(running){
    vy+=gravity;
    x+=vx;
    y+=vy;

    const floorY=floor.offsetTop;

    if(y+ballR>=floorY && vy>0){
      y=floorY-ballR;
      vy=-vy*restitution;
      bounced++;

      /* 伸び */
      vx+=vx*spinStrength(level);

      if(bounced>=2){
        running=false;
        judgeEl.textContent='✖';
        judgeEl.style.color='#f33';
        combo=0;
        updateScore();
        setTimeout(serve,600);
      }
    }

    ball.style.transform=`translate(${x-ballR}px,${y-ballR}px)`;
  }
  requestAnimationFrame(loop);
}

/* ===== 開始 ===== */
updateBg(1);
updateScore();
serve();
loop();
</script>

</body>
</html>

