<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>打点判断トレーニング</title>

<style>
body{
  margin:0;
  background:#111;
  color:#fff;
  font-family:sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  overflow:hidden;
}
#game{
  position:relative;
  width:100%;
  max-width:420px;
  height:100vh;
}
#info{
  position:absolute;
  top:10px;
  width:100%;
  text-align:center;
  font-size:22px;
  z-index:10;
}
#judge{
  font-size:42px;
  height:48px;
}
#ball{
  position:absolute;
  width:48px;
  height:48px;
  border-radius:50%;
  background:#fff;
  box-shadow:0 0 14px rgba(255,255,255,0.9);
}
#floor{
  position:absolute;
  bottom:80px;
  width:100%;
  height:4px;
  background:#888;
}
</style>
</head>

<body>

<div id="game">
  <div id="info">
    <div id="judge"></div>
    Lv <span id="lv">1</span>　
    ⭐ <span id="score">1.0</span>
  </div>
  <div id="ball"></div>
  <div id="floor"></div>
</div>

<script>
const bgColors=['#111','#1a2635','#1a3526','#352a1a','#351a1a','#261a35','#351a35','#1a1a1a','#000'];
function updateBg(lv){
  document.body.style.background =
    bgColors[Math.min(lv-1,bgColors.length-1)];
}

const ball=document.getElementById('ball');
const floor=document.getElementById('floor');
const judgeEl=document.getElementById('judge');
const lvEl=document.getElementById('lv');
const scoreEl=document.getElementById('score');

let level=1, combo=0;
let x=0,y=0,vx=0,vy=0;
let gravity=0.6;
let magnus=0;
let running=false;
let bounced=0;
let touched=false;

const ballR=24;
const restitution=0.85;

/* ===== 打ち出し ===== */
function serve(){
  const floorY=floor.offsetTop;

  bounced=0;
  touched=false;
  judgeEl.textContent='';

  y=floorY-140;   // 高さ固定
  x=40;

  /* 横スピード */
  if(level<=8){
    vx = 3 + level*0.9;
    if(level>=6) vx += (level-5)*2.5;
  }else{
    // Lv9は速度固定（Lv8相当）
    vx = 3 + 8*0.9 + (8-5)*2.5;
  }

  /* 縦初速 & マグヌス */
  if(level<=4){
    vy = -4 + level*0.5;
    magnus = 0;
  }
  else if(level===5){
    vy = -1;
    magnus = 0.015;
  }
  else if(level===6){
    vy = 1;
    magnus = 0.035;
  }
  else if(level===7){
    vy = 2.5;
    magnus = 0.055;
  }
  else if(level===8){
    vy = 4;
    magnus = 0.075;
  }
  else{
    // Lv9：さらに下向きで手前に落とす
    vy = 6;
    magnus = 0.095;
  }

  gravity = level<3 ? 0.3 : 0.6;
  running=true;
}

/* ===== タッチ ===== */
ball.addEventListener('pointerdown',()=>{
  if(bounced===1 && !touched){
    touched=true;
    running=false;
    judgeEl.textContent='〇';
    judgeEl.style.color='#0f9';

    combo++;
    if(combo>=5){
      level++;
      combo=0;
      updateBg(level);
    }
    updateScore();
    setTimeout(serve,600);
  }
});

/* ===== スコア ===== */
function updateScore(){
  lvEl.textContent=level;
  scoreEl.textContent=`${level}.${combo}`;
}

/* ===== ループ ===== */
function loop(){
  if(running){
    vy+=gravity;
    vy+=magnus;

    x+=vx;
    y+=vy;

    const floorY=floor.offsetTop;

    if(y+ballR>=floorY && vy>0){
      y=floorY-ballR;
      vy=-vy*restitution;
      bounced++;

      if(bounced>=2){
        running=false;
        judgeEl.textContent='✖';
        judgeEl.style.color='#f33';
        combo=0;
        updateScore();
        setTimeout(serve,600);
      }
    }

    ball.style.transform=`translate(${x-ballR}px,${y-ballR}px)`;
  }
  requestAnimationFrame(loop);
}

updateBg(1);
updateScore();
serve();
loop();
</script>

</body>
</html>
