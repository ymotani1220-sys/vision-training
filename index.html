<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å“çƒ ç¬é–“åˆ¤æ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #111;
  color: #fff;
  margin: 0;
}

#game { padding: 20px; }

.arrow {
  font-size: 100px;
  margin: 30px 0;
}

#feedback {
  font-size: 40px;
  height: 50px;
}

.correct { color: #00ff99; }
.wrong { color: #ff5555; }

button {
  font-size: 22px;
  padding: 15px 25px;
  margin: 10px;
}

.hidden { display: none; }

#ranking {
  text-align: left;
  max-width: 320px;
  margin: 10px auto;
}
</style>
</head>

<body>

<!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
<div id="startScreen">
  <h1>ğŸ“ ç¬é–“åˆ¤æ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
  <input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›" />
  <br><br>
  <button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="game" class="hidden">
  ğŸ‘¤ <span id="nameDisplay"></span><br>
  â± æ®‹ã‚Š <span id="time">60</span> ç§’<br>
  ğŸ¯ ãƒ¬ãƒ™ãƒ« <span id="level">1</span><br>
  ğŸ”¥ é€£ç¶š <span id="combo">0</span><br>
  â­ ã‚¹ã‚³ã‚¢ <span id="score">1.0</span>

  <div id="arrow" class="arrow"></div>
  <div id="feedback"></div>

  <button onclick="answer('left')">â†</button>
  <button onclick="answer('up')">â†‘</button>
  <button onclick="answer('right')">â†’</button>
</div>

<!-- çµæœï¼†ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div id="result" class="hidden">
  <h2>ğŸ‰ çµæœ</h2>
  <p id="finalScore"></p>

  <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP100</h3>
  <ol id="ranking"></ol>

  <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
</div>

<script>
/* ===== å¤‰æ•° ===== */
let level = 1;
let combo = 0;
let maxCombo = 0;
let time = 60;
let currentAnswer = '';
let timer = null;
let player = '';
let state = 'idle'; // idle / showing / judging

const arrows = ['left','up','right'];
const arrowIcons = { left:'â†', up:'â†‘', right:'â†’' };

/* ãƒ¬ãƒ™ãƒ«åˆ¥ï¼ˆã‚„ã•ã—ã‚ã€œä¸Šç´šï¼‰ */
const showTimes = [1500,1300,1100,900,750,600,450];
const coolTimes = [600,550,500,450,400,350,300];

/* ===== ã‚²ãƒ¼ãƒ é–‹å§‹ ===== */
function startGame() {
  player = document.getElementById('playerName').value || 'ã‚²ã‚¹ãƒˆ';
  document.getElementById('nameDisplay').textContent = player;

  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');

  nextQuestion();
  timer = setInterval(countDown, 1000);
}

/* ===== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ===== */
function countDown() {
  time--;
  document.getElementById('time').textContent = time;
  if (time <= 0) endGame();
}

/* ===== æ¬¡ã®å•é¡Œ ===== */
function nextQuestion() {
  state = 'showing';
  document.getElementById('feedback').textContent = '';

  currentAnswer = arrows[Math.floor(Math.random() * arrows.length)];
  const arrowEl = document.getElementById('arrow');
  arrowEl.textContent = arrowIcons[currentAnswer];

  setTimeout(() => {
    if (state === 'showing') {
      judge(false); // æ™‚é–“åˆ‡ã‚Œ
    }
  }, showTimes[level - 1]);
}

/* ===== å›ç­” ===== */
function answer(choice) {
  if (state !== 'showing') return;
  judge(choice === currentAnswer);
}

/* ===== åˆ¤å®š ===== */
function judge(correct) {
  state = 'judging';
  const fb = document.getElementById('feedback');
  document.getElementById('arrow').textContent = '';

  if (correct) {
    fb.textContent = 'âœ…';
    fb.className = 'correct';
    combo++;
    if (combo > maxCombo) maxCombo = combo;

    if (combo >= 5 && level < 7) {
      level++;
      combo = 0;
    }
  } else {
    fb.textContent = 'âŒ';
    fb.className = 'wrong';
    combo = 0;
  }

  updateDisplay();

  setTimeout(() => {
    state = 'idle';
    nextQuestion();
  }, coolTimes[level - 1]);
}

/* ===== è¡¨ç¤ºæ›´æ–° ===== */
function updateDisplay() {
  document.getElementById('level').textContent = level;
  document.getElementById('combo').textContent = combo;
  document.getElementById('score').textContent = `${level}.${maxCombo}`;
}

/* ===== çµ‚äº† ===== */
function endGame() {
  clearInterval(timer);

  saveScore();
  showRanking();

  document.getElementById('game').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');

  document.getElementById('finalScore').textContent =
    `ã‚¹ã‚³ã‚¢ï¼š${level}.${maxCombo}`;
}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ ===== */
function saveScore() {
  const scoreValue = Number(`${level}.${maxCombo}`);
  const record = { name: player, score: scoreValue };

  let ranking = JSON.parse(localStorage.getItem('ranking')) || [];
  ranking.push(record);

  ranking.sort((a, b) => b.score - a.score);
  ranking = ranking.slice(0, 100);

  localStorage.setItem('ranking', JSON.stringify(ranking));
}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ===== */
function showRanking() {
  const ranking = JSON.parse(localStorage.getItem('ranking')) || [];
  const list = document.getElementById('ranking');
  list.innerHTML = '';

  ranking.forEach((r, i) => {
    const li = document.createElement('li');
    li.textContent = `${i + 1}. ${r.name}ï¼ˆ${r.score}ï¼‰`;
    list.appendChild(li);
  });
}
</script>

</body>
</html>
