<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å“çƒ ç¬é–“åˆ¤æ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #111;
  color: #fff;
  margin: 0;
}
.arrow { font-size: 100px; margin: 30px 0; }
#feedback { font-size: 40px; height: 50px; }
.correct { color:#0f9; }
.wrong { color:#f55; }
button { font-size:22px; padding:15px 25px; margin:10px; }
.hidden { display:none; }
#ranking { text-align:left; max-width:320px; margin:auto; }
</style>
</head>

<body>

<div id="start">
  <h1>ğŸ“ ç¬é–“åˆ¤æ–­ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
  <input id="playerName" placeholder="åå‰">
  <br><br>
  <button onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="game" class="hidden">
  ğŸ‘¤ <span id="name"></span><br>
  â± <span id="time">60</span> ç§’ã€€
  ğŸ¯ Lv <span id="level">1</span>ã€€
  ğŸ”¥ <span id="combo">0</span><br>
  â­ <span id="score">1.0</span>

  <div id="arrow" class="arrow"></div>
  <div id="feedback"></div>

  <button onclick="answer('left')">â†</button>
  <button onclick="answer('up')">â†‘</button>
  <button onclick="answer('right')">â†’</button>
</div>

<div id="result" class="hidden">
  <h2>ğŸ‰ çµæœ</h2>
  <p id="finalScore"></p>
  <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
  <ol id="ranking"></ol>
  <button onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
</div>

<script>
/* ===== å¤‰æ•° ===== */
let level = 1;
let combo = 0;
let maxCombo = 0;
let time = 60;
let timer = null;
let questionTimer = null;
let player = '';
let answered = false;
let current = '';
let level7TotalCombo = 0;

const arrows = ['left','up','right'];
const icons = {left:'â†', up:'â†‘', right:'â†’'};
const showTimes = [1500,1300,1100,900,750,600,450];

/* ===== é–‹å§‹ ===== */
function startGame(){
  player = document.getElementById('playerName').value || 'ã‚²ã‚¹ãƒˆ';
  document.getElementById('name').textContent = player;

  document.getElementById('start').classList.add('hidden');
  document.getElementById('game').classList.remove('hidden');

  timer = setInterval(()=>{
    time--;
    document.getElementById('time').textContent = time;
    if(time<=0) endGame();
  },1000);

  nextQuestion();
}

/* ===== æ¬¡ã®å•é¡Œ ===== */
function nextQuestion(){
  clearTimeout(questionTimer);
  answered = false;
  document.getElementById('feedback').textContent = '';

  current = arrows[Math.floor(Math.random()*3)];
  document.getElementById('arrow').textContent = icons[current];

  questionTimer = setTimeout(()=>{
    if(!answered) judge(false);
  }, showTimes[level-1]);
}

/* ===== å›ç­” ===== */
function answer(choice){
  if(answered) return;
  judge(choice === current);
}

/* ===== åˆ¤å®š ===== */
function judge(correct){
  answered = true;
  clearTimeout(questionTimer);
  document.getElementById('arrow').textContent = '';

  const fb = document.getElementById('feedback');

  if(correct){
    fb.textContent = 'âœ…';
    combo++;
    maxCombo = Math.max(maxCombo, combo);

    if(level < 7 && combo >= 5){
      level++;
      combo = 0;
    }

    if(level === 7){
      level7TotalCombo++;
    }

  } else {
    fb.textContent = 'âŒ';
    combo = 0;
  }

  updateUI();
  setTimeout(nextQuestion, 400);
}

/* ===== è¡¨ç¤ºæ›´æ–° ===== */
function updateUI(){
  document.getElementById('level').textContent = level;
  document.getElementById('combo').textContent = combo;

  let scoreBase = level;
  let scoreDecimal = maxCombo;

  if(level === 7){
    scoreBase = 7 + Math.floor(level7TotalCombo / 5);
    scoreDecimal = level7TotalCombo % 5 + 1;
  }

  document.getElementById('score').textContent =
    `${scoreBase}.${scoreDecimal}`;
}

/* ===== çµ‚äº† ===== */
function endGame(){
  clearInterval(timer);
  clearTimeout(questionTimer);

  saveScore();
  showRanking();

  document.getElementById('game').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');
  document.getElementById('finalScore').textContent =
    `ã‚¹ã‚³ã‚¢ï¼š${document.getElementById('score').textContent}`;
}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== */
function saveScore(){
  const scoreText = document.getElementById('score').textContent;
  const score = Number(scoreText);
  const r = {name:player, score};

  const list = JSON.parse(localStorage.getItem('ranking')||'[]');
  list.push(r);
  list.sort((a,b)=>b.score-a.score);
  localStorage.setItem('ranking', JSON.stringify(list.slice(0,100)));
}

function showRanking(){
  const list = JSON.parse(localStorage.getItem('ranking')||'[]');
  const ol = document.getElementById('ranking');
  ol.innerHTML = '';
  list.forEach((r,i)=>{
    const li = document.createElement('li');
    li.textContent = `${i+1}. ${r.name}ï¼ˆ${r.score}ï¼‰`;
    ol.appendChild(li);
  });
}
</script>

</body>
</html>
