<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>横回転判断トレーニング - iPhone最適化ver</title>

<style>
body{
  margin:0;
  background:#111;
  font-family:sans-serif;
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  height:100vh;
  overflow: hidden;
  touch-action: manipulation;
}

/* ===== 共通パネル ===== */
.info-panel {
  width: 100%;
  max-width: 400px;
  padding: 10px;
  display: flex;
  justify-content: space-around;
  font-size: 18px;
  text-align: center;
}
.score-highlight { font-size: 26px; color: #ffeb3b; font-weight: bold; }

/* ===== コートエリア (iPhone向け最適化) ===== */
.court-wrapper{
  position:relative;
  width: 100vw; /* 画面幅いっぱいを基準に */
  max-width: 375px; /* iPhoneの標準的な幅 */
  height: 380px;
  margin: 5px 0;
}

.court{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width: 220px; /* ★台を少し狭くして左右の余白を確保 */
  height: 100%;
  background: #1c6b3c;
  border: 3px solid #fff;
  box-sizing: border-box;
}

.line{ position:absolute; background:#fff; }
.centerline{ left:50%; top:0; width:2px; height:100%; transform:translateX(-50%); opacity: 0.6; }
.net{
  position:absolute; top:50%; left:0; width:100%; height:4px;
  background:rgba(255,255,255,0.8); z-index:2;
}

/* ===== ボールと回転演出 ===== */
.ball{
  position:absolute;
  width:22px;
  height:22px;
  background:#ffcc00;
  border-radius:50%;
  transform:translate(-50%,-50%);
  z-index:10;
  box-shadow: 0 0 10px rgba(255,204,0,0.8);
}

.spin-arrow{
  position:absolute;
  width:70px;
  height:70px;
  border:5px solid #ff5555;
  border-radius:50%;
  display:none;
  z-index: 5;
  opacity: 0.5;
}
.spin-arrow.ccw{ border-right-color:transparent; animation: spin-ccw 0.5s linear infinite; }
.spin-arrow.cw{ border-left-color:transparent; animation: spin-cw 0.5s linear infinite; }

@keyframes spin-ccw { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(-360deg); } }
@keyframes spin-cw { from { transform: translate(-50%,-50%) rotate(0deg); } to { transform: translate(-50%,-50%) rotate(360deg); } }

/* ===== 判断ボタンエリア ===== */
.buttons-container {
  display: flex;
  gap: 8px;
  margin-top: 5px;
}

.btn-col{
  display:flex;
  flex-direction:column;
  gap:6px;
  background: rgba(255,255,255,0.05);
  padding: 6px;
  border-radius: 10px;
}

.btn{
  width: 75px;
  height: 40px;
  background:#444;
  border-radius:20px;
  border:2px solid #fff;
  position:relative;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
}

.btn.correct{background:#0f9 !important; box-shadow: 0 0 10px #0f9;}
.btn.wrong{background:#f33 !important; box-shadow: 0 0 10px #f33;}

.angle-line{ width:28px; height:4px; background:#fff; border-radius: 2px; }
.angle-left{ transform: rotate(-25deg); }
.angle-center{ transform: rotate(0deg); }
.angle-right{ transform: rotate(25deg); }

#feedback { font-size: 36px; height: 40px; font-weight: bold; margin-bottom: 5px; }
</style>
</head>

<body>

<div class="info-panel">
  <div>⏱ <span id="timeDisp">60</span></div>
  <div>スコア：<span id="scoreDisp" class="score-highlight">1.0</span></div>
</div>

<div id="feedback"></div>

<div class="court-wrapper" id="wrapper">
  <div class="spin-arrow" id="spinArrow"></div>
  <div class="court">
    <div class="line centerline"></div>
    <div class="net"></div>
  </div>
  <div class="ball" id="ball"></div>
</div>

<div class="buttons-container" id="buttons"></div>

<script>
let currentLvl = 1;
let currentCombo = 0;
let timeLeft = 60;
let correctCol = 0;
let correctSpin = 1;
let isAnswered = false;
let gameActive = true;

const speedSettings = [2500, 2200, 1900, 1600, 1300, 1100, 900, 800];
const curvePower = 70; // ★iPhoneで画面外に出ないよう少し調整

const ball = document.getElementById("ball");
const spinArrow = document.getElementById("spinArrow");
const wrapper = document.getElementById("wrapper");

/* ボタン生成 */
for(let col=0; col<3; col++){
  const colDiv=document.createElement("div");
  colDiv.className="btn-col";
  ["left","center","right"].forEach(type=>{
    const btn=document.createElement("div");
    btn.className="btn";
    btn.dataset.col=col;
    btn.dataset.type=type;
    const line=document.createElement("div");
    line.className="angle-line angle-"+type;
    btn.appendChild(line);
    btn.onclick=()=>judge(btn);
    colDiv.appendChild(btn);
  });
  document.getElementById("buttons").appendChild(colDiv);
}

/* タイマー */
const timerId = setInterval(() => {
  if(!gameActive) return;
  timeLeft--;
  document.getElementById("timeDisp").textContent = timeLeft;
  if(timeLeft <= 0) {
    gameActive = false;
    clearInterval(timerId);
    alert("修行終了！ スコア: " + currentLvl + "." + currentCombo);
    location.reload();
  }
}, 1000);

function curveOffset(p, spin){
  if(spin === 1) return 0;
  const dir = (spin === 0) ? -1 : 1;
  return Math.sin(p * Math.PI) * curvePower * dir;
}

function launchBall(){
  if(!gameActive) return;
  isAnswered = false;
  document.getElementById("feedback").textContent = "";
  
  const w = wrapper.clientWidth;
  const courtW = 220; // 台の幅
  const baseLeft = (w - courtW) / 2;
  
  // 台の幅に合わせてスタート位置を調整
  const startCols = [baseLeft + 30, w/2, baseLeft + courtW - 30];

  const startCol = Math.floor(Math.random()*3);
  const spin = Math.floor(Math.random()*3);

  correctCol = startCol;
  correctSpin = spin;

  const startX = startCols[startCol];
  const startY = 20;
  const endY = 360;

  spinArrow.style.display = spin === 1 ? "none" : "block";
  spinArrow.className = "spin-arrow " + (spin === 0 ? "ccw" : "cw");
  spinArrow.style.left = startX + "px";
  spinArrow.style.top = startY + "px";

  const startTime = performance.now();
  const duration = speedSettings[Math.min(currentLvl-1, speedSettings.length-1)];

  function animate(t){
    if(!gameActive) return;
    const p = Math.min((t - startTime) / duration, 1);
    const x = startX + curveOffset(p, spin);
    const y = startY + (endY - startY) * p;

    ball.style.left = x + "px";
    ball.style.top = y + "px";

    if(p < 1 && !isAnswered) {
      requestAnimationFrame(animate);
    } else if (p >= 1 && !isAnswered) {
      judge(null);
    }
  }
  requestAnimationFrame(animate);
}

function judge(btn){
  if(isAnswered || !gameActive) return;
  isAnswered = true;
  
  const fb = document.getElementById("feedback");
  const spinType = correctSpin === 0 ? "right" : correctSpin === 1 ? "center" : "left";

  if(btn && Number(btn.dataset.col) === correctCol && btn.dataset.type === spinType){
    btn.classList.add("correct");
    fb.textContent = "〇"; fb.style.color = "#0f9";
    currentCombo++;
    if(currentCombo >= 5) { currentLvl++; currentCombo = 0; }
  } else {
    if(btn) btn.classList.add("wrong");
    fb.textContent = "✖"; fb.style.color = "#f33";
    currentCombo = 0;
  }

  document.getElementById("scoreDisp").textContent = currentLvl + "." + currentCombo;
  
  setTimeout(()=>{
    document.querySelectorAll(".btn").forEach(b=>b.classList.remove("correct","wrong"));
    if(gameActive) launchBall();
  }, 600);
}

launchBall();
</script>
</body>
</html>
