<script>
const ball = document.getElementById("ball");
const result = document.getElementById("result");
const info = document.getElementById("info");

const floorY = 400;

const levels = [
  { gravity: 0.25, speed: 1.6 },
  { gravity: 0.30, speed: 1.9 },
  { gravity: 0.38, speed: 2.3 },
  { gravity: 0.46, speed: 2.7 }
];

let level = 0;
let success = 0;

let x, y, vx, vy;
let bounceCount = 0;
let canTouch = false;
let touched = false;
let ballActive = true;

function resetBall() {
  x = 40;
  y = 80;
  vx = levels[level].speed;
  vy = 0;
  bounceCount = 0;
  canTouch = false;
  touched = false;
  ballActive = true;
  ball.style.display = "block";
}

resetBall();

function update() {
  if (!ballActive) {
    requestAnimationFrame(update);
    return;
  }

  const g = levels[level].gravity;

  x += vx;
  y += vy;
  vy += g;

  // バウンド判定
  if (y >= floorY) {
    y = floorY;
    vy = -vy * 0.85;
    bounceCount++;

    if (bounceCount === 1) {
      canTouch = true;
    }

    if (bounceCount === 2 && !touched) {
      showResult(false);
    }
  }

  ball.style.left = x + "px";
  ball.style.top = y + "px";

  requestAnimationFrame(update);
}

document.getElementById("game").addEventListener("click", () => {
  if (!canTouch || touched || !ballActive) return;

  touched = true;
  ballActive = false;
  ball.style.display = "none"; // ← 打ったので消す
  showResult(true);
});

function showResult(ok) {
  if (ok) {
    result.textContent = "〇";
    result.style.color = "green";
    success++;

    if (success >= 3 && level < levels.length - 1) {
      level++;
      success = 0;
    }
  } else {
    result.textContent = "✖";
    result.style.color = "red";
    success = 0;
  }

  info.textContent = `Lv ${level + 1}`;

  setTimeout(() => {
    result.textContent = "";
    resetBall();
  }, 700);
}

update();
</script>

